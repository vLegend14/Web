---
import { withBase } from "@/utils/url";

const slides = [
  {
    title: "GUARDIAS DE SEGURIDAD",
    subtitle: "PERSONAL CAPACITADO.",
    img: withBase("/img/GGSS-slides.jpg"),
    alt: "Guardias de Seguridad",
    href: withBase("/guardias-de-seguridad/"),
  },
  {
    title: "ALARMAS",
    subtitle: "CONECTADOS A CARABINEROS DE CHILE ‚Äì ALPHA III",
    img: withBase("/img/alarmas-slides.jpg"),
    alt: "Alarmas",
    href: withBase("/vigilancia-electronica/sistema-de-alarma/"),
  },
  {
    title: "VIDEO VIGILANCIA",
    subtitle: "SISTEMAS DE C√ÅMARAS DE SEGURIDAD.",
    img: withBase("/img/CCTV-slides.jpg"),
    alt: "Video Vigilancia",
    href: withBase("/vigilancia-electronica/camaras-de-seguridad/"),
  },
];
---

<!-- ================= CARRUSEL ================= -->
<section
  class="relative z-10 w-full overflow-hidden select-none bg-protec-900 isolate"
  aria-label="Carrusel principal"
>
  <!-- TRACK -->
  <div
    id="carousel"
    class="flex transition-transform duration-700 ease-in-out will-change-transform"
  >
    {slides.map((s, idx) => (
      <div class="min-w-full relative" data-slide={idx}>
        <img
          src={s.img}
          alt={s.alt}
          class="w-full h-[60vh] md:h-[520px] lg:h-[520px]"
          draggable="false"
          loading="eager"
        />

        <div class="absolute inset-0 bg-protec-950/55"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-protec-950/60 via-protec-900/25 to-transparent"></div>

        <div class="absolute inset-0 flex flex-col justify-center items-center text-white text-center px-6">
          <h2 class="text-2xl md:text-4xl lg:text-5xl font-semibold tracking-wide uppercase">
            {s.title}
          </h2>

          <p class="mt-3 max-w-2xl text-sm md:text-lg text-protec-100">
            {s.subtitle}
          </p>

          <a
            href={s.href}
            class="mt-8 inline-flex items-center justify-center rounded-xl
                   bg-protec-600 hover:bg-protec-500 active:bg-protec-700 transition-colors
                   px-8 py-3 text-sm font-semibold text-white shadow-lg ring-1 ring-white/10"
          >
            Ver servicio
          </a>
        </div>
      </div>
    ))}
  </div>

  <!-- BOTONES -->
  <button
    type="button"
    id="prev"
    aria-label="Anterior"
    class="absolute left-4 top-1/2 -translate-y-1/2
           bg-protec-950/40 text-white rounded-full w-11 h-11
           flex items-center justify-center
           ring-1 ring-white/10 shadow-lg
           hover:bg-protec-950/60 transition"
  >
    ‚Äπ
  </button>

  <button
    type="button"
    id="next"
    aria-label="Siguiente"
    class="absolute right-4 top-1/2 -translate-y-1/2
           bg-protec-950/40 text-white rounded-full w-11 h-11
           flex items-center justify-center
           ring-1 ring-white/10 shadow-lg
           hover:bg-protec-950/60 transition"
  >
    ‚Ä∫
  </button>

  <!-- L√≠nea inferior -->
  <div class="absolute bottom-0 left-0 w-full h-1 bg-protec-700"></div>
</section>
<!-- ================= FIN CARRUSEL ================= -->

<script>
// @ts-nocheck

(() => {
  const track = document.getElementById("carousel");
  const prevBtn = document.getElementById("prev");
  const nextBtn = document.getElementById("next");
  if (!track) return;

  const container = track.parentElement;
  if (!container) return;

  const realSlides = Array.from(track.children);
  const n = realSlides.length;

  if (n <= 1) {
    prevBtn?.remove();
    nextBtn?.remove();
    return;
  }

  // ---- Clones: [lastClone][real...][firstClone]
  const firstClone = realSlides[0].cloneNode(true);
  const lastClone  = realSlides[n - 1].cloneNode(true);
  firstClone.setAttribute("data-clone", "first");
  lastClone.setAttribute("data-clone", "last");
  track.insertBefore(lastClone, realSlides[0]);
  track.appendChild(firstClone);

  // 0 = lastClone, 1..n = reales, n+1 = firstClone
  let index = 1;

  const intervalMs = 6000;
  let timer = null;

  // Drag state
  let isDragging = false;
  let startX = 0;
  let currentX = 0;
  let startTranslatePx = 0;

  // üîí lock durante animacion (evita ‚Äúblanco‚Äù)
  let isAnimating = false;
  let animFallback = null;

  const widthNow = () => container.clientWidth || 1;

  const setTransition = (on) => {
    track.style.transition = on ? "transform 700ms ease-in-out" : "none";
  };

  const translateToIndex = (i, animate = true) => {
    index = i;

    if (animate) {
      isAnimating = true;
      if (animFallback) clearTimeout(animFallback);
      animFallback = setTimeout(() => {
        isAnimating = false;
        animFallback = null;
      }, 750);
    }

    setTransition(animate);
    const x = -index * widthNow();
    track.style.transform = `translate3d(${x}px, 0, 0)`;
  };

  const normalizeIfClone = () => {
    if (index === 0) translateToIndex(n, false);
    if (index === n + 1) translateToIndex(1, false);
  };

  const stopAuto = () => {
    if (timer) clearInterval(timer);
    timer = null;
  };

  const startAuto = () => {
    stopAuto();
    timer = setInterval(() => next(), intervalMs);
  };

  const next = () => {
    if (isAnimating || isDragging) return;
    normalizeIfClone();
    translateToIndex(index + 1, true);
  };

  const prev = () => {
    if (isAnimating || isDragging) return;
    normalizeIfClone();
    translateToIndex(index - 1, true);
  };

  track.addEventListener("transitionend", () => {
    isAnimating = false;
    if (animFallback) {
      clearTimeout(animFallback);
      animFallback = null;
    }

    if (index === n + 1) requestAnimationFrame(() => translateToIndex(1, false));
    else if (index === 0) requestAnimationFrame(() => translateToIndex(n, false));
  });

  prevBtn?.addEventListener("click", () => { stopAuto(); prev(); startAuto(); });
  nextBtn?.addEventListener("click", () => { stopAuto(); next(); startAuto(); });

  // Pointer events (swipe)
  const onDown = (e) => {
    if (isAnimating) return;
    if (e.pointerType === "mouse" && e.button !== 0) return;

    normalizeIfClone();
    isDragging = true;
    stopAuto();
    setTransition(false);

    startX = e.clientX;
    currentX = startX;
    startTranslatePx = -index * widthNow();

    track.setPointerCapture?.(e.pointerId);
  };

  const onMove = (e) => {
    if (!isDragging) return;
    currentX = e.clientX;
    const dx = currentX - startX;
    track.style.transform = `translate3d(${startTranslatePx + dx}px, 0, 0)`;
  };

  const onUp = () => {
    if (!isDragging) return;
    isDragging = false;

    const dx = currentX - startX;
    const w = widthNow();
    const threshold = w * 0.2;

    if (dx <= -threshold) translateToIndex(index + 1, true);
    else if (dx >= threshold) translateToIndex(index - 1, true);
    else translateToIndex(index, true);

    startAuto();
  };

  track.style.touchAction = "pan-y";
  track.style.willChange = "transform";

  track.addEventListener("pointerdown", onDown);
  track.addEventListener("pointermove", onMove);
  track.addEventListener("pointerup", onUp);
  track.addEventListener("pointercancel", onUp);
  track.addEventListener("pointerleave", onUp);

  // Init
  translateToIndex(1, false);
  startAuto();
  window.addEventListener("resize", () => translateToIndex(index, false));
})();
</script>